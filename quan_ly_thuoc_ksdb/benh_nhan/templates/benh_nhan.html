{% extends "base.html" %}
{% block title %}
Quản lý bệnh nhân
{% endblock %}
{% block content %}
<div class="container mt-5">
    <h2 class="text-center">Danh sách bệnh nhân</h2>
    
    <!-- Form tìm kiếm -->
    <form method="GET" action="" class="row g-3 mb-4">
        <div class="col-md-3">
            <input type="text" class="form-control" name="ma_benh_nhan" placeholder="Mã bệnh nhân" value="{{ request.GET.ma_benh_nhan }}">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" name="ho_ten" placeholder="Họ tên" value="{{ request.GET.ho_ten }}">
        </div>
        <div class="col-md-3">
            <input type="date" class="form-control" name="ngay_sinh" placeholder="Ngày sinh" value="{{ request.GET.ngay_sinh }}">
        </div>
        <div class="col-md-3">
            <select class="form-control" name="khoa">
                <option value="">--- Chọn Khoa ---</option>
                {% for choice_key, choice_value in form.khoa.field.choices %}
                <option value="{{ choice_key }}" {% if choice_key == request.GET.khoa %}selected{% endif %}>{{ choice_value }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-12 text-center">
            <button type="submit" class="btn btn-primary">Tìm kiếm</button>
        </div>
    </form>

    <!-- Nút thêm bệnh nhân -->
    <div class="mb-4 text-end">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#themBenhNhanModal">
            Thêm bệnh nhân
        </button>
    </div>

    <!-- Danh sách bệnh nhân -->
    <table class="table table-bordered">
        <thead>
            <tr align='center'>
                <th>Mã bệnh nhân</th>
                <th>Họ tên</th>
                <th>Ngày sinh</th>
                <th>Khoa</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody>
            {% for bn in benh_nhans %}
            <tr>
                <td align='center'>{{ bn.ma_benh_nhan }}</td>
                <td>{{ bn.ho_ten }}</td>
                <td align='center' class='text_center'>{{ bn.ngay_sinh|date:"d/m/Y" }}</td>
                <td>{{ bn.get_khoa_display }}</td>
                <td align='center'>
                    <button type="button" class="btn btn-info btn-md" data-bs-toggle="modal" data-bs-target="#suaBenhNhanModal{{ bn.id }}">Sửa</button>
                    <a href="{% url 'xoa_benh_nhan' bn.id %}" class="btn btn-danger btn-md">Xoá</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center">Không có bệnh nhân nào được tìm thấy.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal Thêm -->
<div class="modal fade" id="themBenhNhanModal" tabindex="-1" aria-labelledby="themBenhNhanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="themBenhNhanModalLabel">Thêm bệnh nhân</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'them_benh_nhan' %}">
                    {% csrf_token %}
                    {% for field in form %}
                        <div class="form-group mb-3">
                            {{ field.label_tag }}
                            {{ field }}
                            {% if field.errors %}
                                <div class="invalid-feedback">
                                    {% for error in field.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-primary btn-block">Thêm</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Sửa -->
{% for bn in benh_nhans %}
<div class="modal fade" id="suaBenhNhanModal{{ bn.id }}" tabindex="-1" aria-labelledby="suaBenhNhanModalLabel{{ bn.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="suaBenhNhanModalLabel{{ bn.id }}">Sửa bệnh nhân</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'sua_benh_nhan' bn.id %}">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label for="ma_benh_nhan">Mã bệnh nhân</label>
                        <input type="text" class="form-control" id="ma_benh_nhan" name="ma_benh_nhan" value="{{ bn.ma_benh_nhan }}" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="ho_ten">Họ tên</label>
                        <input type="text" class="form-control" id="ho_ten" name="ho_ten" value="{{ bn.ho_ten }}" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="ngay_sinh">Ngày sinh</label>
                        <input type="date" class="form-control" id="ngay_sinh" name="ngay_sinh" value="{{ bn.ngay_sinh|date:'Y-m-d' }}" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="khoa">Khoa</label>
                        <select class="form-control" id="khoa" name="khoa">
                            <option value="">--- Chọn Khoa ---</option>
                            {% for choice_key, choice_value in form.fields.khoa.choices %}
                            <option value="{{ choice_key }}" {% if choice_key == bn.khoa %}selected{% endif %}>{{ choice_value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Lưu thay đổi</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
<script>
    $(document).ready(function() {
        $('#modalForm').on('submit', function(e) {
            e.preventDefault(); // Ngăn không gửi form theo cách mặc định
            
            $.ajax({
                type: 'POST',
                url: $(this).attr('action'),
                data: $(this).serialize(),
                success: function(response) {
                    if (response.success) {
                        // Cập nhật nội dung modal hoặc hiển thị thông báo thành công
                        $('#modalContent').html(response.html);
                        $('#modal').modal('hide'); // Đóng modal nếu cần
                    } else {
                        // Hiển thị lỗi trong modal
                        $('#modalContent').html(response.html);
                    }
                },
                error: function() {
                    alert('Đã có lỗi xảy ra.');
                }
            });
        });
    });
</script
<!-- Bootstrap JS and dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.10.2/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.min.js"></script>
{% endblock %}
    
